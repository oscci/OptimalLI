---
title: "CompareLIs"
author: "Dorothy Bishop"
date: "2023-05-13"
output: html_document
---

18/5/23
updated after adding 95% CI for weighted LI mean
20/5/23
updated to read in the big LI file: li_toolbox_all_tasks_masks_LB.csv
This has 5 and 95% CI

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(here)
require(janitor) #clean up names from external files
```

## Data from fMRI

3 tasks: Word Generation, Auditory Naming and Pyramids and Palm Trees.  
(Also for ftcd on WG and PPT but not AN).
For WG1 comparison is with rest (contrast 1).
for AN5 it is with backward speech (contrast 5).   
for PP5 it is with line judgement (contrast 5).  
PP1 is semantic judgement vs rest
PP3 is line drawings vs rest

We have data from LI toolbox analysis (already done by Zoe - which includes N voxels - though that seems odd as with bootstrap N voxels is constant? She told me she had hacked into script to get this - maybe this is N voxels at a specific threshold?). For now will read in just the regular LIs. 

We also now have data from my flip method, which includes differences and 95% CI for differences, plus t-values as well as means for L and R volumes. 

Also have latest fTCD LIs using GAM method for WG1 and PP1

All LI and flip rerun using tstat data

NB one missing file for AN and one for PPT. 
 AN is missing subject 085, and PPT is missing subject 068


```{r readdata}
demog <- read_csv(here("Bruckert","_bruckert_summarydat.csv"))
# we'll use this just for demographics, handedness etc
allLI <- read.csv(here("Bruckert","LIComparisons","li_toolbox_all_tasks_masks_LB.csv"))
allLI <- clean_names(allLI)
allLI$id <- substr(allLI$id,1,3) #just first 3 chars

#find task buried in input_image
allLI$task <- NA
taskID <- c('wordgen_tstat1','ppt_tstat1','ppt_tstat3','ppt_tstat5','audnam_tstat5')
task <- c('WG1','PP1','PP3','PP5','AN5')

for (t in 1:length(task)){
  w<-which(grepl(taskID[t],allLI$input_image)==TRUE)
  allLI$task[w] <-task[t]
}

mask <- c('mca','frontal','temporal','parietal','cerebellar')
allLI$mask <- NA
for (m in 1:length(mask)){
  maskname <- paste0('LI-',mask[m],'-mask.img,1')
   w<-which(grepl(maskname,allLI$inclusive_mask)==TRUE)
  allLI$mask[w] <-mask[m]
}



#flip files with 5% selected (can substitute another file if need be)
flip_all <- read.csv(here("Bruckert","LIComparisons","Summaryfliptab_all_1000_5.csv"))
flip_all<-clean_names(flip_all)
w<-which(flip_all$mask=='MCA')
flip_all$mask[w]<-'mca'
flip_all$id<-substr(flip_all$id,1,3)


#Now find the GAM values for doppler
dop_wg1 <- read.csv(here("Bruckert","LIComparisons","DopplerGAM_WG1.csv"))
dop_pp1 <- read.csv(here("Bruckert","LIComparisons","DopplerGAM_pp1.csv"))
dop_wg1$C_lowCI <- dop_wg1$C_LI.est-1.96*dop_wg1$C_LIest.se
dop_wg1$C_hiCI <- dop_wg1$C_LI.est+1.96*dop_wg1$C_LIest.se
dop_pp1$C_lowCI <- dop_pp1$C_LI.est-1.96*dop_pp1$C_LIest.se
dop_pp1$C_hiCI <- dop_pp1$C_LI.est+1.96*dop_pp1$C_LIest.se

```

#scale the doppler values by dividing by 6, and the flip values by dividing by 2.7.
#these values determined by looking at max values
#Aim to bring into range with the LIs - but not otherwise equiv


```{r makebigdf}
demog$id <- substr(demog$ID,1,3)

#Long form with methods, tasks, masks all stacked
bigdf<-flip_all[,c(1,2,3,4,11,12,13,14)]

names(bigdf)[c(4,5,6)]<-c('mean','lowCI','hiCI')
#scale flip values by dividing by 2.7 (maximum val for hi CI is 2.657)
bigdf[,4:6]<-bigdf[,4:6]/2.7
bigdf$method <- 'flip'

#cols for var weighting and clustering just used here as padding for correct N cols
addbit<-allLI[,c('id','variance_weighting','clustering','li_wm','li_p5','li_p95','mask','task')]
addbit$method='toolbox'
addbit[,2:3]<-NA
names(addbit)<-names(bigdf)
bigdf<-rbind(bigdf,addbit)


#Now add Doppler - just 2 tasks, equiv to WG1 and PP5 - use NExtreme, nFinal,odd and even for padding

dopbit1 <- dop_wg1[,c('Filename','nExtreme','nFinal','C_LI.est','C_lowCI','C_hiCI','odd','even')]
dopbit1$even <- 'WG1'

dopbit2 <- dop_pp1[,c('Filename','nExtreme','nFinal','C_LI.est','C_lowCI','C_hiCI','odd','even')]
dopbit2$even <- 'PP1'
dopbit <- rbind(dopbit1,dopbit2)

dopbit$method <- 'Doppler'
names(dopbit) <- names(bigdf)
dopbit$id <- substr(dopbit$id,1,3)
dopbit[,2:3]<-NA
dopbit$mask <- 'mca'

#Scale doppler by dividing by 6
w<-which(names(dopbit)=='mean')
dopbit[,w:(w+2)]<-dopbit[,w:(w+2)]/6

#now exclude those who did not do fMRI
w<-which(dopbit$id %in% bigdf$id)
bigdf<- rbind(bigdf,dopbit[w,])


bigdf$hand <- NA
bigdf$lat_group <- NA
for (i in 1:nrow(demog)){
  w<-which(bigdf$id==demog$id[i])
  bigdf$hand[w]<-demog$hand_self_report[i]
  bigdf$lat_group[w]<-demog$group_lat[i]
}

bigdf$nonRH <- 1
bigdf$handcolour <- 'red'
bigdf$nonRH[bigdf$hand=="R"] <- 0
bigdf$handcolour[bigdf$hand=="R"]  <-'blue'
mypch <- c(19,1,10) #filled circle, open circle, circle with cross -hmm not good with ggplot
bigdf$pchcol <- mypch[bigdf$lat_group]
bigdf$pchcol <- as.factor(bigdf$pchcol)
bigdf$lat_group <- as.factor(bigdf$lat_group)
levels(bigdf$lat_group)<- c('Left','Bilateral','Right')

```


Now we can look at some comparisons - start within task

```{r tryplot}
#column with 'diff'
method1 <- 'Doppler'
method2 <- 'flip'
mytask <- 'PP1'
mymask <- 'mca'
if(method1=='Doppler' || method2 =='Doppler')
  {mymask <- 'mca'}

xfile <- filter(bigdf,method==method1 & task==mytask & mask==mymask)
yfile <-  filter(bigdf,method==method2 & task==mytask & mask==mymask)

#Check that rows are equivalent
s<-c(xfile$id,yfile$id)
mycount<-table(s)
my2 <- names(which(mycount==2))
xfile<-xfile[xfile$id %in% my2,]
yfile <- yfile[yfile$id %in% my2,]
w<-which(names(xfile)=='mean')
names(xfile)[w:(w+2)]<-c('x','xmin','xmax')
names(yfile)[w:(w+2)]<-c('y','ymin','ymax')

forplot<-cbind(xfile,yfile[,w:(w+2)])

correlcoef <- round(cor.test (forplot$x, forplot$y, method = "spearman",  exact = FALSE)$estimate,3)

myplot <- ggplot(data = forplot,aes(x = x,y = y)) + 
  geom_point(aes(col=lat_group),size=2)+
  geom_errorbar(aes(ymin = ymin,ymax = ymax,col=lat_group)) + 
  geom_errorbarh(aes(xmin = xmin,xmax = xmax,col=lat_group))+
  geom_hline(yintercept = 0, linetype="solid",col='grey') + 
  geom_vline(xintercept = 0, linetype= "solid", col='grey')  + 
  xlab(method1)+
  ylab(method2)+
  ggtitle(paste0(mymask,": ",mytask))+
  annotate("text",x = -.5, y = .9, label = paste('r = ', correlcoef),col='black')
 



```

